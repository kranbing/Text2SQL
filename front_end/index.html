<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text2SQL Studio Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .slide-enter { max-height: 500px; opacity: 1; transition: all 0.3s ease-in-out; }
        .slide-exit { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s ease-in-out; }
    </style>
    </head>
<body class="bg-gray-50 h-screen flex flex-col text-slate-800 font-sans">

    <div class="bg-white shadow-sm border-b border-gray-200 z-20">
        <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-database text-indigo-600"></i>
                <span class="font-bold text-lg tracking-tight">Text2SQL Studio</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="btnSettings" class="text-gray-500 hover:text-indigo-600 transition-colors" title="设置">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button onclick="togglePanel()" class="text-gray-500 hover:text-indigo-600 transition-colors">
                    <span class="text-sm mr-1">工具与配置</span>
                    <i id="toggleIcon" class="fa-solid fa-chevron-up transition-transform duration-300"></i>
                </button>
            </div>
        </div>

        <div id="controlPanel" class="slide-enter border-t border-gray-100 bg-gray-50/50">
            <div class="max-w-5xl mx-auto px-4 py-4 space-y-4">
                <div>
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-2">扩展功能</h3>
                    <div class="flex flex-wrap gap-3">
                        <button id="btnUpload" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:border-indigo-300 hover:text-indigo-600 transition shadow-sm">
                            <i class="fa-solid fa-file-arrow-up"></i> 上传批量查询
                        </button>
                        <button id="btnUpdateKB" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:border-indigo-300 hover:text-indigo-600 transition shadow-sm">
                            <i class="fa-solid fa-book"></i> 更新知识库
                        </button>
                        <button id="btnShowSchema" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:border-indigo-300 hover:text-indigo-600 transition shadow-sm">
                            <i class="fa-solid fa-table"></i> 展示表结构
                        </button>
                        <button id="btnShowRag" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm hover:border-indigo-300 hover:text-indigo-600 transition shadow-sm">
                            <i class="fa-solid fa-database"></i> 展示知识库
                        </button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xs font-semibold text-gray-400 uppercase mb-2">输出配置</h3>
                    <div class="flex flex-wrap gap-6">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <div class="relative inline-flex items-center cursor-pointer">
                                <input id="toggleJson" type="checkbox" value="" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </div>
                            <span class="text-sm text-gray-600 group-hover:text-gray-900">保存为 JSON</span>
                        </label>
                        
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <div class="relative inline-flex items-center cursor-pointer">
                                <input id="toggleExplain" type="checkbox" value="" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </div>
                            <span class="text-sm text-gray-600 group-hover:text-gray-900">显示执行计划</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <div class="relative inline-flex items-center cursor-pointer">
                                <input id="toggleDryRun" type="checkbox" value="" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            </div>
                            <span class="text-sm text-gray-600 group-hover:text-gray-900">干运行</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600">LIMIT</span>
                            <input id="limitInput" type="number" min="1" value="100" class="text-sm bg-gray-50 border border-gray-300 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 w-24" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 scroll-smooth" id="chatContainer">
        <div class="max-w-3xl mx-auto space-y-6 py-6">
            <div class="flex gap-4">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-robot text-indigo-600 text-sm"></i>
                </div>
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 max-w-[85%]">
                    <p class="text-gray-700 text-sm mb-3">你好！我是 Text2SQL 助手。请告诉我你想查询什么数据？</p>
                    <div class="bg-gray-50 rounded p-2 border border-gray-200" id="connInfo">
                        <p class="text-xs text-gray-500 font-mono">Connected: 未设置</p>
                    </div>
                </div>
            </div>
            <div id="conversationAnchor"></div>
            <div id="replyAnchor"></div>
        </div>
    </div>

    <div class="bg-white border-t border-gray-200 p-4">
        <div class="max-w-3xl mx-auto relative">
            <textarea id="queryInput" placeholder="输入您的自然语言查询..." class="w-full bg-gray-50 border border-gray-300 rounded-xl py-3 pl-4 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border透明 resize-none shadow-sm" rows="1"></textarea>
            <button id="sendBtn" class="absolute right-2 bottom-2 p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
        <div class="text-center mt-2">
            <span class="text-xs text-gray-400">AI 生成内容可能存在误差，请在执行前检查 SQL。</span>
        </div>
    </div>

    <script>
        let isOpen = true;
        const panel = document.getElementById('controlPanel');
        const icon = document.getElementById('toggleIcon');
        const connInfo = document.getElementById('connInfo');
        const sendBtn = document.getElementById('sendBtn');
        const queryInput = document.getElementById('queryInput');
        const conversationAnchor = document.getElementById('conversationAnchor');
        const replyAnchor = document.getElementById('replyAnchor');
        const btnUpload = document.getElementById('btnUpload');
        const btnUpdateKB = document.getElementById('btnUpdateKB');
        const btnShowSchema = document.getElementById('btnShowSchema');
        const btnShowRag = document.getElementById('btnShowRag');
        
        const toggleSchema = document.getElementById('toggleSchema') || { checked: false };
        const toggleJson = document.getElementById('toggleJson');
        const toggleExplain = document.getElementById('toggleExplain');
        const toggleDryRun = document.getElementById('toggleDryRun');
        const limitInput = document.getElementById('limitInput');
        const chatContainer = document.getElementById('chatContainer');

        function togglePanel() {
            isOpen = !isOpen;
            if (isOpen) {
                panel.classList.remove('slide-exit');
                panel.classList.add('slide-enter');
                icon.classList.remove('rotate-180');
            } else {
                panel.classList.remove('slide-enter');
                panel.classList.add('slide-exit');
                icon.classList.add('rotate-180');
            }
        }

        const getBaseUrl = () => localStorage.getItem('text2sql_base_url') || 'http://127.0.0.1:8001/v1';
        const refreshConnInfo = async () => {
            try {
                const j = await apiGet('/database/info');
                const info = j?.data || {};
                const text = info.database ? (info.database + ' 已连接') : '未设置';
                connInfo.querySelector('p').textContent = text;
            } catch (e) {
                connInfo.querySelector('p').textContent = '未设置';
            }
        };
        refreshConnInfo();
        

        const cfg = () => ({ show_schema_insight: toggleSchema.checked, execute_sql: !toggleDryRun.checked, export_json: toggleJson.checked, use_rag: true, explain: toggleExplain.checked });
        const apiGet = async (path) => {
            const url = getBaseUrl().replace(/\/$/, '') + path;
            const r = await fetch(url);
            return r.json();
        };
        const apiPost = async (path, body) => {
            const url = getBaseUrl().replace(/\/$/, '') + path;
            const r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            return r.json();
        };

        const appendAssistant = (html) => {
            const row = document.createElement('div');
            row.className = 'flex gap-4 items-start';
            row.innerHTML = '<div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-robot text-indigo-600 text-sm"></i></div>' +
                '<div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 w-full max-w-[85%]">' + html + '</div>';
            replyAnchor.before(row);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        const appendUser = (text) => {
            const row = document.createElement('div');
            row.className = 'flex gap-4 flex-row-reverse items-start';
            row.innerHTML = '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><i class="fa-regular fa-user text-gray-600 text-sm"></i></div>' +
                '<div class="bg-indigo-600 p-4 rounded-2xl rounded-tr-none shadow-md text-white max-w-[85%]"><p class="text-sm"></p></div>';
            row.querySelector('p').textContent = text;
            conversationAnchor.after(row);
        };

        sendBtn.addEventListener('click', async () => {
            const q = queryInput.value.trim();
            if (!q) return;
            appendUser(q);
            queryInput.value = '';
            queryInput.style.height = '';
            const pending = document.createElement('div');
            pending.className = 'flex gap-4 items-start';
            pending.innerHTML = '<div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0"><i class="fa-solid fa-robot text-indigo-600 text-sm"></i></div>' +
                '<div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 w-full max-w-[85%]"><div class="text-sm text-gray-500"><span class="inline-block w-2 h-2 bg-indigo-600 rounded-full animate-bounce mr-1"></span> 正在生成...</div></div>';
            replyAnchor.before(pending);
            let j;
            try {
                j = await apiPost('/chat/completion', { message: q, config: cfg(), limit: parseInt(limitInput.value || '100', 10) });
            } catch (e) {
                pending.querySelector('.bg-white').innerHTML = '<div class="text-sm text-red-600">网络错误或跨域受限，请检查 Base URL 与后端 CORS 设置</div>';
                return;
            }
            const data = j && j.data ? j.data : {};
            if (data.sql_query) {
                let html = '<p class="text-gray-700 text-sm mb-2">已生成 SQL 查询语句：</p>' +
                  '<pre class="bg-slate-800 text-green-400 p-3 rounded-lg text-xs font-mono overflow-x-auto mb-2">' + (data.sql_query || '') + '</pre>';
                if (data.query_result && Array.isArray(data.query_result.columns)) {
                    html += '<div class="mt-3 border-t pt-3"><p class="text-xs text-gray-500 mb-2">执行结果预览：</p>';
                    html += '<table class="w-full text-xs text-left"><thead class="bg-gray-50 text-gray-500 font-semibold"><tr>';
                    data.query_result.columns.forEach(c => { html += '<th class="p-2">' + c + '</th>'; });
                    html += '</tr></thead><tbody class="divide-y">';
                    (data.query_result.rows || []).forEach(row => { html += '<tr>' + row.map(cell => '<td class="p-2">' + String(cell) + '</td>').join('') + '</tr>'; });
                    html += '</tbody></table></div>';
                }
                if (data.exports && data.exports.json_url) {
                    html += '<div class="mt-3"><span class="text-xs text-gray-500 mr-2">导出：</span>' +
                      '<a class="text-indigo-600" target="_blank" rel="noreferrer" href="' + data.exports.json_url + '">JSON</a>' +
                      '</div>';
                }
                pending.querySelector('.bg-white').innerHTML = html;
            }
        });

        const resizeInput = () => {
            const lh = parseFloat(getComputedStyle(queryInput).lineHeight) || 20;
            const maxH = lh * 3;
            queryInput.style.height = 'auto';
            const h = Math.min(queryInput.scrollHeight, maxH);
            queryInput.style.height = h + 'px';
            queryInput.style.overflowY = (queryInput.scrollHeight > maxH) ? 'auto' : 'hidden';
        };
        queryInput.addEventListener('input', resizeInput);
        queryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });

        btnShowSchema.addEventListener('click', async () => {
            let j;
            try { j = await apiGet('/database/schema'); } catch (e) { appendAssistant('<div class="text-sm text-red-600">获取表结构失败</div>'); return; }
            const tables = (j?.data?.tables || []);
            let html = '<p class="text-sm text-gray-700 mb-2">数据库表结构：</p>';
            tables.forEach(t => {
                html += '<div class="mb-2"><div class="text-xs font-semibold text-gray-600">' + t.table_name + '</div>';
                html += '<div class="text-xs text-gray-500">' + (t.columns || []).map(c => c.name).join(', ') + '</div></div>';
            });
            appendAssistant(html);
        });

        btnShowRag.addEventListener('click', async () => {
            let j;
            try { j = await apiGet('/rag/show'); } catch (e) { appendAssistant('<div class="text-sm text-red-600">获取知识库失败</div>'); return; }
            const files = j?.data?.files || [];
            let html = '<p class="text-sm text-gray-700 mb-2">知识库文件：</p>';
            files.forEach(f => { html += '<div class="mb-2"><div class="text-xs font-semibold text-gray-600">' + f.name + '</div><div class="text-xs text-gray-500">' + (f.preview || '') + '</div></div>'; });
            appendAssistant(html);
        });
        

        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'file';
        hiddenInput.className = 'hidden';
        document.body.appendChild(hiddenInput);
        let taskType = 'batch_query';
        btnUpload.addEventListener('click', () => { taskType = 'batch_query'; hiddenInput.click(); });
        btnUpdateKB.addEventListener('click', () => { taskType = 'update_kb'; hiddenInput.click(); });
        hiddenInput.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const fd = new FormData();
            fd.append('file', file);
            fd.append('task_type', taskType);
            let j;
            try {
                const url = getBaseUrl().replace(/\/$/, '') + '/tools/upload';
                const r = await fetch(url, { method: 'POST', body: fd });
                j = await r.json();
            } catch (e2) {
                alert('上传失败，检查 Base URL 或 CORS');
                return;
            }
            const tid = j?.data?.task_id;
            if (!tid) return;
            appendAssistant('<div class="text-sm">任务创建: ' + tid + '</div>');
            const poll = async () => {
                try {
                    const s = await apiGet('/tools/task/' + tid);
                    const st = s?.data?.status;
                    appendAssistant('<div class="text-sm">任务状态: ' + st + '</div>');
                    if (st === 'completed' || st === 'failed') {
                        if (s?.data?.result_url) {
                            appendAssistant('<a class="text-indigo-600" target="_blank" rel="noreferrer" href="' + s.data.result_url + '">下载结果</a>');
                        }
                        return true;
                    }
                } catch (e3) {}
                return false;
            };
            let done = await poll();
            const i = setInterval(async () => { if (done) { clearInterval(i); } else { done = await poll(); } }, 2000);
        });

        
    </script>
    
    <script>
        (function initSettingsModal(){
            const overlay = document.createElement('div');
            overlay.id = 'settingsModal';
            overlay.className = 'fixed inset-0 bg-black/50 hidden items-center justify-center z-30';
            overlay.innerHTML = '<div class="bg-white w-[720px] h-[520px] rounded-xl shadow-lg overflow-hidden">\n' +
                '<div class="flex h-full">\n' +
                '<div class="w-48 h-full border-r bg-gray-50 p-4 space-y-2">\n' +
                '<button class="w-full text-left text-sm py-2 px-2 rounded hover:bg-gray-100" data-tab="db">数据库连接设置</button>\n' +
                '<button class="w-full text-left text-sm py-2 px-2 rounded hover:bg-gray-100" data-tab="kb">知识库连接设置</button>\n' +
                '<button class="w-full text-left text-sm py-2 px-2 rounded hover:bg-gray-100" data-tab="api">后端接口配置设置</button>\n' +
                '</div>\n' +
                '<div class="flex-1 h-full flex flex-col">\n' +
                '<div id="tab-db" class="flex-1 overflow-auto p-6 space-y-3">\n' +
                '<div><label class="text-sm text-gray-600">数据库连接字符串(DB_URL)</label><input id="cfgDbUrl" class="w-full mt-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="mysql://user:pass@host:3306/db"/></div>\n' +
                '<div><label class="text-sm text-gray-600">数据库方言(DIALECT)</label><input id="cfgDialect" class="w-full mt-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="mysql"/></div>\n' +
                '</div>\n' +
                '<div id="tab-kb" class="flex-1 overflow-auto p-6 space-y-3 hidden">\n' +
                '<div><label class="text-sm text-gray-600">知识库目录(KB_DIR)</label><input id="cfgKbDir" class="w-full mt-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="D:/path/to/kb"/></div>\n' +
                '<div><label class="text-sm text-gray-600">文件匹配(KB_GLOB)</label><input id="cfgKbGlob" class="w-full mt-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="**/*.md"/></div>\n' +
                '</div>\n' +
                '<div id="tab-api" class="flex-1 overflow-auto p-6 space-y-3 hidden">\n' +
                '<div><label class="text-sm text-gray-600">后端接口 Base URL</label><input id="cfgBaseUrl" class="w-full mt-1 bg-gray-50 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="http://127.0.0.1:8001/v1"/></div>\n' +
                '</div>\n' +
                '<div class="p-4 border-t flex justify-end gap-2">\n' +
                '<button id="cfgCancel" class="px-3 py-2 text-sm bg-gray-100 rounded hover:bg-gray-200">取消</button>\n' +
                '<button id="cfgSave" class="px-3 py-2 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700">保存</button>\n' +
                '</div>\n' +
                '</div>\n' +
                '</div>';
            document.body.appendChild(overlay);
            const tabs = overlay.querySelectorAll('[data-tab]');
            tabs.forEach(btn => btn.addEventListener('click', () => {
                overlay.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
                overlay.querySelector('#tab-' + btn.getAttribute('data-tab')).classList.remove('hidden');
            }));
            overlay.querySelector('#cfgCancel').addEventListener('click', () => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); });
            overlay.querySelector('#cfgSave').addEventListener('click', async () => {
                const body = {
                    db_url: overlay.querySelector('#cfgDbUrl').value || undefined,
                    dialect: overlay.querySelector('#cfgDialect').value || undefined,
                    kb_dir: overlay.querySelector('#cfgKbDir').value || undefined,
                    kb_glob: overlay.querySelector('#cfgKbGlob').value || undefined,
                };
                try { await apiPost('/config/update', body); } catch(e) {}
                const bu = overlay.querySelector('#cfgBaseUrl').value.trim();
                if (bu) { localStorage.setItem('text2sql_base_url', bu); }
                refreshConnInfo();
                overlay.classList.add('hidden'); overlay.classList.remove('flex');
            });
            document.getElementById('btnSettings').addEventListener('click', async () => {
                try {
                    const j = await apiGet('/database/info');
                    const info = j?.data || {};
                    overlay.querySelector('#cfgDbUrl').value = info.url || '';
                    overlay.querySelector('#cfgDialect').value = info.dialect || 'mysql';
                } catch (e) {}
                overlay.querySelector('#cfgBaseUrl').value = getBaseUrl();
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            });
        })();
    </script>
</body>
</html>